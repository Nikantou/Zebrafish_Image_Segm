from skimage.feature import peak_local_max
from skimage.morphology import watershed
from scipy import ndimage
import numpy as np
import imutils
import cv2 as cv
import matplotlib.pyplot as plt


image = cv.imread("C:/Users/nito_/Desktop/image.png")
shifted = cv.pyrMeanShiftFiltering(image, 21, 51)

cv_image_invert = cv.bitwise_not(image)
img = cv.cvtColor(cv_image_invert, cv.COLOR_BGR2GRAY)
gray = cv.cvtColor(image, cv.COLOR_BGR2GRAY)
thresh = cv.threshold(img, 0, 255, cv.THRESH_BINARY | cv.THRESH_OTSU)[1]
plt.imshow(thresh, "gray")

eucliddist = ndimage.distance_transform_edt(thresh)
localMax = peak_local_max(eucliddist, indices=False, min_distance=25,
	labels=thresh)

markers = ndimage.label(localMax, structure=np.ones((3, 3)))[0]
labels = watershed(-eucliddist, markers, mask=thresh)
print((len(np.unique(labels)) - 1), "Segments"), print(type(markers)),print(labels.shape),print(markers.shape)

Arearect = [0]*len(np.unique(labels))
Areacirc = [0]*len(np.unique(labels))
for label in np.unique(labels):
    if label == 0:
        continue
    mask = np.zeros(gray.shape, dtype = "uint8")
    mask[labels == label] = 255
    contours = cv.findContours(mask.copy(), cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE)
    contours = imutils.grab_contours(contours)
    c = max(contours, key = cv.contourArea)
    ((x,y), r) = cv.minEnclosingCircle(c)
    boundRect = cv.boundingRect(c)
    Arearect[label] = boundRect[2]*boundRect[3]
    Areacirc[label] = np.pi*(r**2)
    if 10000 < Areacirc[label] < 80000:
        cv.circle(image, (int(x), int(y)), int(r), (0, 255, 2))
    if 10000 < Arearect[label] < 80000:
        cv.rectangle(image, (int(boundRect[0]), int(boundRect[1])), \
                 (int(boundRect[0] + boundRect[2]), int(boundRect[1]+boundRect[3])), (0, 255, 0), 2)
    


plt.imshow(image, "gray")